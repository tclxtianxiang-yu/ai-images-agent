# AI Images Agent PRD

## 1. 背景
- 团队希望提供一个“上传任意图片即可得到标准化描述 + 云端链接”的轻量服务，用于营销素材管理、运营团队协作以及后续多模态 Agent 训练集积累。
- 现有 Mastra + Next.js 脚手架已搭建，但功能仍停留在示例，需要定义清晰的产品需求推动实现。

## 2. 产品目标
1. **上传体验顺畅**：任意图片（PNG/JPEG/WebP, ≤10MB）可拖拽或选择上传。
2. **自动交付结果**：30 秒内返回压缩后图片的 Cloudflare R2 地址和自然语言描述。
3. **稳定可观测**：上传/生成失败需有可见提示与可追踪日志，失败率 <1%。

## 3. 用户画像
- **运营/编辑**：需要快速生成素材描述、复制链接到 CMS。
- **开发/测试**：验证 Mastra 工具链与 R2 上传链路，期望有日志与调试入口。

## 4. 用户流程
1. 用户打开页面，看到上传面板。
2. 用户拖入图片或点击选择文件。
3. 前端立即进行尺寸/MIME 校验并展示预览 + 进度。
4. 前端调用 Next.js API / Server Action，将文件传给 Mastra Workflow。
5. Workflow 执行：压缩 → 上传 R2 → AI 生成描述。
6. API 将描述与 R2 公网 URL 返回前端，界面展示结果，并提供「复制链接」按钮（R2自定义域名: https://static.mikasa-ackerman.vip）。
7. 用户复制链接或下载描述文本，如需继续可再次上传。

## 5. 功能需求
| 编号 | 功能 | 描述 | 验收标准 |
| --- | --- | --- | --- |
| F1 | 上传入口 | 支持拖拽/点击上传，展示文件名/大小状态 | 不合法文件提示错误且不进入后端 |
| F2 | 进度与状态 | 显示上传、压缩、上传 R2、描述生成的阶段进度 | 各阶段状态明确，失败时可重试 |
| F3 | Mastra Workflow | 可串联三个工具：压缩、上传、描述 | Workflow 输出包含描述文本 + R2 URL |
| F4 | 结果展示 | 显示缩略图、描述文本、R2 URL 及复制按钮 | 复制按钮点击后提示“已复制” |
| F5 | 历史记录（可选） | 本地存储最近 5 条结果，页面刷新仍可查看 | 开关决定是否记忆，默认开启 |
| F6 | 日志/监控 | 工具执行事件记录至日志，便于排查 | Cloudflare Logpush 或 Wrangler tail 可看到日志 |

## 6. 非功能需求
- **性能**：单图端到端 ≦30s，前端交互保持 60fps；Workers CPU 时间 < 10ms（AI 调用除外）。
- **可靠性**：R2 上传失败时自动重试 2 次并报警；描述生成失败时仍返回 R2 URL。
- **安全**：限制仅允许图片 MIME，使用临时上传凭证；可配置 API Key 保护。
- **可观测性**：记录每次请求的 traceId、文件大小、执行时长。

## 7. 核心指标
- 成功上传转化率 ≥98%。
- 平均处理耗时 ≤15s。
- R2 链接复制点击率 ≥80%。
- 日志中错误级别事件 <1 次/100 请求。

## 8. 里程碑
1. **MVP (Week 1)**：完成上传 UI + Workflow 串联 + R2 上传 + 描述展示。
2. **Beta (Week 2-3)**：补充日志、错误处理、复制按钮、基础监控。
3. **GA (Week 4)**：性能优化、可观测性完善、权限接入、文档补充。

## 9. 风险与依赖
- 大模型 API 限流：需准备备用模型或重试策略。
- Workers 限制（CPU/Binary）导致压缩失败：可考虑引入 Cloudflare Queues + Durable Objects 处理耗时任务。
- R2 公共读权限：需确保通过签名 URL 或自定义域避免泄露私有资源。
